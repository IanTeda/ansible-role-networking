# ============================================================================ #
# VPN Kill Switch UFW Rules Template                                           #
# ============================================================================ #
# ⚠️ WARNING: This file is managed by Ansible - DO NOT EDIT MANUALLY!       ⚠️ 
# Any manual changes will be overwritten on the next Ansible run.
# Edit the template file or Ansible variables instead.
#
# Template:   roles/networking/templates/kill-switch-before.rules.j2
# Deploy to:  /etc/ufw/before.rules
# =============================================================================
#
# Rules that should be run before the ufw command line added rules. Custom
# rules should be added to one of these chains:
#   ufw-before-input
#   ufw-before-output
#   ufw-before-forward
#
# Rules are processed sequentially (allows before drops), which is correct. 
# Established connections are allowed first, preventing issues with return traffic.
#
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Host: {{ ansible_fqdn }}
# Updated: {{ ansible_date_time.iso8601 }} (v1.1 - Working kill switch with logging)
# -----------------------------------------------------------------------------

# Don't delete these required lines, otherwise there will be errors
*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]
:ufw-not-local - [0:0]
# End required lines

# allow all on loopback
-A ufw-before-input -i lo -j ACCEPT
-A ufw-before-output -o lo -j ACCEPT

# quickly process packets for which we already have a connection
-A ufw-before-input -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-output -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-forward -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# drop INVALID packets (logs these in loglevel medium and higher)
-A ufw-before-input -m conntrack --ctstate INVALID -j ufw-logging-deny
-A ufw-before-input -m conntrack --ctstate INVALID -j DROP

# ok icmp codes for INPUT
-A ufw-before-input -p icmp --icmp-type destination-unreachable -j ACCEPT
-A ufw-before-input -p icmp --icmp-type time-exceeded -j ACCEPT
-A ufw-before-input -p icmp --icmp-type parameter-problem -j ACCEPT
-A ufw-before-input -p icmp --icmp-type echo-request -j ACCEPT

# ok icmp code for FORWARD
-A ufw-before-forward -p icmp --icmp-type destination-unreachable -j ACCEPT
-A ufw-before-forward -p icmp --icmp-type time-exceeded -j ACCEPT
-A ufw-before-forward -p icmp --icmp-type parameter-problem -j ACCEPT
-A ufw-before-forward -p icmp --icmp-type echo-request -j ACCEPT

# allow dhcp client to work
-A ufw-before-input -p udp --sport 67 --dport 68 -j ACCEPT

# ==============================================================================
# VPN KILL SWITCH RULES
# ==============================================================================
# These rules ensure all traffic goes through the VPN interface
# Traffic is blocked if the VPN is down

##-- 1. Allow traffic to local/private networks (RFC 1918)
# This allows access to your LAN even when VPN is active
-A ufw-before-output -d 10.0.0.0/8 -j ACCEPT
-A ufw-before-output -d 172.16.0.0/12 -j ACCEPT
-A ufw-before-output -d 192.168.0.0/16 -j ACCEPT
# This allows incoming traffic from local/private networks (LAN)
-A ufw-before-input -s 10.0.0.0/8 -j ACCEPT
-A ufw-before-input -s 172.16.0.0/12 -j ACCEPT
-A ufw-before-input -s 192.168.0.0/16 -j ACCEPT

##-- 2. Allow connections to the VPN server itself
# This is critical - without this, the VPN cannot establish a connection
# Allow UDP (WireGuard port) and ICMP (for handshake/ping)
-A ufw-before-output -d {{ killswitch_server_ip }} -p udp --dport 51820 -j ACCEPT
-A ufw-before-output -d {{ killswitch_server_ip }} -p icmp -j ACCEPT
-A ufw-before-input -s {{ killswitch_server_ip }} -p icmp -j ACCEPT

# Allow outgoing ICMP for diagnostics (e.g., ping)
-A ufw-before-output -p icmp -j ACCEPT

# Optional: Allow DNS queries to specific wireguard servers
# Useful if you need to resolve the VPN server hostname
{% for dns_server in killswitch_dns_servers %}
-A ufw-before-output -d {{ dns_server }} -p udp --dport 53 -j ACCEPT
-A ufw-before-output -d {{ dns_server }} -p tcp --dport 53 -j ACCEPT
{% endfor %}

# Optional: Allow NTP for time synchronization (useful for VPN stability)
# Allow NTP for time synchronization (useful for VPN stability)
-A ufw-before-output -p udp --dport 123 -j ACCEPT

## --3. Allow ALL traffic out and in through the VPN interface
# This is the main rule that routes internet traffic through VPN
-A ufw-before-output -o {{ killswitch_vpn_interface }} -j ACCEPT
-A ufw-before-input -i {{ killswitch_vpn_interface }} -j ACCEPT

# KILL SWITCH: Drop all other outbound traffic on primary interface
# If VPN is down, no traffic leaks to the internet
# Add logging to debug (check /var/log/ufw.log or /var/log/kern.log)
-A ufw-before-output -o {{ killswitch_default_interface }} -j LOG --log-prefix "KILL SWITCH OUTPUT DROP: "
-A ufw-before-output -o {{ killswitch_default_interface }} -j DROP
-A ufw-before-input -i {{ killswitch_default_interface }} -j LOG --log-prefix "KILL SWITCH INPUT DROP: "
-A ufw-before-input -i {{ killswitch_default_interface }} -j DROP
-A ufw-before-forward -i {{ killswitch_default_interface }} -j LOG --log-prefix "KILL SWITCH FORWARD DROP: "
-A ufw-before-forward -i {{ killswitch_default_interface }} -j DROP

# ------------------------ [END VPN KILL SWITCH] -------------------------------

#
# ufw-not-local
#
-A ufw-before-input -j ufw-not-local

# if LOCAL, RETURN
-A ufw-not-local -m addrtype --dst-type LOCAL -j RETURN

# if MULTICAST, RETURN
-A ufw-not-local -m addrtype --dst-type MULTICAST -j RETURN

# if BROADCAST, RETURN
-A ufw-not-local -m addrtype --dst-type BROADCAST -j RETURN

# all other non-local packets are dropped
-A ufw-not-local -m limit --limit 3/min --limit-burst 10 -j ufw-logging-deny
-A ufw-not-local -j DROP

# allow MULTICAST mDNS for service discovery (be sure the MULTICAST line above
# is uncommented)
-A ufw-before-input -p udp -d 224.0.0.251 --dport 5353 -j ACCEPT

# allow MULTICAST UPnP for service discovery (be sure the MULTICAST line above
# is uncommented)
-A ufw-before-input -p udp -d 239.255.255.250 --dport 1900 -j ACCEPT

# don't delete the 'COMMIT' line or these rules won't be processed
COMMIT
