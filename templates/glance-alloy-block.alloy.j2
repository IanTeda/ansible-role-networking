// Glance Alloy Configuration Block
// ==================================
//
// This configuration collects logs and metrics from Glance service.
// Glance is a beautiful dashboard for self-hosted services and applications.
//
// Components:
// - Log collection from systemd journal (Debian) or Docker (Docker)
// - Log processing to clean timestamps
// - Optional metrics collection (if enabled)
//
// Generated by Ansible from glance-alloy-block.alloy.j2 template
// Generated on: {{ ansible_date_time.iso8601 }}
// ===

{% if networking_glance.install_method == "debian" %}
// Send Glance systemd journal logs to Loki (Debian installation)
loki.source.journal "glance" {
  matches = "_SYSTEMD_UNIT=glance.service"
  relabel_rules = loki.relabel.systemd_journal.rules
  forward_to = [loki.process.glance.receiver]
}
{% else %}
// Send Glance Docker container logs to Loki (Docker installation)
loki.source.docker "glance" {
  host = "unix:///var/run/docker.sock"
  targets = ["{{ networking_glance.container_name | default('glance') }}"]
  relabel_rules = loki.relabel.docker.rules
  forward_to = [loki.process.glance.receiver]
}
{% endif %}

loki.process "glance" {
  // Remove Glance timestamp prefix like: [2025-11-08 10:30:15] INFO ...
  stage.regex {
    expression = "^\\[[0-9\\-:T\\s]+\\]\\s*(?P<msg>.*)$"
  }
  stage.output {
    source = "msg"
  }

  // Add service label for better organization
  stage.labels {
    values = {
      service = "glance",
      component = "dashboard",
      type = "web-interface",
    }
  }

  forward_to = [loki.write.endpoint.receiver]
}

{% if networking_glance.metrics_enabled | default(false) %}
// Collect Glance metrics (if metrics endpoint is available)
prometheus.scrape "glance" {
  targets = [{
    __address__ = "127.0.0.1:{{ networking_glance.metrics_port | default('9463') }}",
    instance = "{{ ansible_hostname }}",
    service = "glance",
  }]

  // Scrape interval
  scrape_interval = "30s"

  // Metric relabeling
  metric_relabel_rules = [
    // Drop unwanted metrics
    rule {
      action = "drop"
      regex = "go_.*"
      source_labels = ["__name__"]
    },
    rule {
      action = "drop"
      regex = "process_.*"
      source_labels = ["__name__"]
    },
    // Add service label
    rule {
      action = "replace"
      target_label = "service"
      replacement = "glance"
    },
    rule {
      action = "replace"
      target_label = "component"
      replacement = "dashboard"
    },
  ]

  forward_to = [prometheus.remote_write.endpoint.receiver]
}
{% endif %}

{% if networking_glance.docker_metrics_enabled | default(false) %}
// Collect Docker container metrics for Glance
prometheus.scrape "glance_docker" {
  targets = [{
    __address__ = "127.0.0.1:9323",  // Docker metrics endpoint
    instance = "{{ ansible_hostname }}",
    service = "glance",
    container = "{{ networking_glance.container_name | default('glance') }}",
  }]

  scrape_interval = "30s"

  // Filter for Glance container only
  metric_relabel_rules = [
    rule {
      action = "keep"
      regex = "{{ networking_glance.container_name | default('glance') }}"
      source_labels = ["container"]
    },
    rule {
      action = "replace"
      target_label = "service"
      replacement = "glance"
    },
    rule {
      action = "replace"
      target_label = "deployment"
      replacement = "docker"
    },
  ]

  forward_to = [prometheus.remote_write.endpoint.receiver]
}
{% endif %}