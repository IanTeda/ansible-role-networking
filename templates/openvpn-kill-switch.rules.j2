# ============================================================================ #
# OpenVPN Kill Switch UFW Rules Template                                      #
# ============================================================================ #
# ⚠️ WARNING: This file is managed by Ansible - DO NOT EDIT MANUALLY!       ⚠️ 
# Any manual changes will be overwritten on the next Ansible run.
# Edit the template file or Ansible variables instead.
#
# file_path: roles/openvpn/templates/openvpn_kill_switch.rules.j2
# =============================================================================
# /etc/ufw/before.rules
#
# Rules that should be run before the ufw command line added rules. Custom
# rules should be added to one of these chains:
#   ufw-before-input
#   ufw-before-output
#   ufw-before-forward
#
# Generated by Ansible on {{ ansible_date_time.iso8601 }}
# Host: {{ ansible_fqdn }}
# Updated: 2025-07-16
# -----------------------------------------------------------------------------

*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]

# Allow all on loopback
-A ufw-before-input -i lo -j ACCEPT
-A ufw-before-output -o lo -j ACCEPT

# Allow ICMP (ping)
-A ufw-before-input -p icmp -j ACCEPT
-A ufw-before-output -p icmp -j ACCEPT

# quickly process packets for which we already have a connection
-A ufw-before-input -m state --state RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-output -m state --state RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-forward -m state --state RELATED,ESTABLISHED -j ACCEPT

# drop INVALID packets
-A ufw-before-input -m state --state INVALID -j DROP

##-- START VPN KILL SWITCH

# Allow all outgoing traffic through the VPN tunnel interface (tun0)
-A ufw-before-output -o tun0 -j ACCEPT

# Allow outgoing traffic to local/private networks (LAN)
-A ufw-before-output -d 10.0.0.0/8 -j ACCEPT
-A ufw-before-output -d 172.16.0.0/12 -j ACCEPT
-A ufw-before-output -d 192.168.0.0/16 -j ACCEPT

# Allow incoming traffic from local/private networks (LAN)
-A ufw-before-input -s 10.0.0.0/8 -j ACCEPT
-A ufw-before-input -s 172.16.0.0/12 -j ACCEPT
-A ufw-before-input -s 192.168.0.0/16 -j ACCEPT

# Allow all incoming traffic from the VPN tunnel interface (tun0)
-A ufw-before-input -i tun0 -j ACCEPT

# Explicitly drop all other incoming traffic on the physical interface
-A ufw-before-input -i {{ vpn_primary_network_interface }} -j DROP

# Allow VPN connection establishment on common UDP ports (from eth0)
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp --dport 1198 -j ACCEPT
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp --dport 1197 -j ACCEPT
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp --dport 1194 -j ACCEPT
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp --dport 8080 -j ACCEPT
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp --dport 9201 -j ACCEPT

# Allow DNS queries (UDP 53) only to DNS servers
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp -d 209.222.18.222 --dport 53 -j ACCEPT
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp -d 209.222.18.218 --dport 53 -j ACCEPT
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp -d 10.0.0.242 --dport 53 -j ACCEPT

# Allow DHCP client to work
-A ufw-before-output -o {{ vpn_primary_network_interface }} -p udp --sport 68 --dport 67 -j ACCEPT

# Drop all other outgoing traffic on {{ vpn_primary_network_interface }} (blocks leaks if VPN goes down)
-A ufw-before-output -o {{ vpn_primary_network_interface }} -j DROP

#-- END VPN KILL SWITCH

COMMIT