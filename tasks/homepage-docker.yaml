# =============================================================================
# Ansible Role: Networking - Homepage Dashboard Docker Installation
# =============================================================================
#
# This file contains tasks for installing Homepage Dashboard using Docker on Debian-based systems.
# Homepage is a modern, fully static, fast, secure, fully proxied, highly customizable
# application dashboard with integrations for various services and applications.
#
# Features:
#   - Modern, fully static dashboard
#   - Fast and secure application dashboard
#   - Highly customizable widgets and layouts
#   - Docker container management
#   - Persistent configuration storage
#   - Nginx reverse proxy configuration
#   - UFW firewall rules
#
# Requirements:
#   - Debian/Ubuntu system with Docker installed
#   - Internet connectivity
#   - Root/sudo access
#   - Nginx role configured (for reverse proxy)
#
# Author: Generated by Ansible
# =============================================================================

## Homepage Docker Role Variables and Facts
# -----------------------------------------------------------------------------

- name: Display Homepage Docker variables for debugging
  ansible.builtin.debug:
    var: networking_homepage
  tags: [debug]

- name: Set Homepage Docker facts for the role
  ansible.builtin.set_fact:
    homepage_user: "{{ networking_homepage.user | default('homepage') }}"
    homepage_group: "{{ networking_homepage.group | default('homepage') }}"
    homepage_groups_additional: "{{ networking_homepage.additional_groups | default([]) }}"
    homepage_port: "{{ networking_homepage.port | default('3000') }}"
    homepage_install_dir: "{{ networking_homepage.install_dir | default('/opt/homepage') }}"
    homepage_data_dir: "{{ networking_homepage.data_dir | default('/var/lib/homepage') }}"
    homepage_config_dir: "{{ networking_homepage.config_dir | default('/etc/homepage') }}"
    homepage_allowed_networks: "{{ networking_homepage.allowed_networks | default(['192.168.1.0/24']) }}"
    homepage_nginx_enabled: "{{ networking_homepage.nginx_enabled | default(true) }}"
    homepage_nginx_root_enabled: "{{ networking_homepage.nginx_root_enabled | default(false) }}"
    homepage_image: "{{ networking_homepage.docker_image | default('ghcr.io/gethomepage/homepage') }}"
    homepage_image_tag: "{{ networking_homepage.release | default('latest') }}"
    homepage_container_name: "{{ networking_homepage.container_name | default('homepage') }}"
    homepage_timezone: "{{ networking_homepage.timezone | default('America/New_York') }}"
    homepage_hostname: "{{ networking_homepage.hostname | default(ansible_hostname) }}"
    homepage_title: "{{ networking_homepage.title | default(ansible_hostname + ' - Homepage') }}"
    homepage_description: "{{ networking_homepage.description | default('A modern, fully static, fast, secure, fully proxied, highly customizable application dashboard') }}"
    homepage_theme: "{{ networking_homepage.theme | default('dracula') }}"
    homepage_allowed_hosts: "{{ networking_homepage.allowed_hosts | default(ansible_hostname + ', ' + ansible_hostname + ':' + networking_homepage.port | default('3000') + ', ' + ansible_fqdn + ', ' + ansible_fqdn + ':' + networking_homepage.port | default('3000')) }}"
    homepage_log_level: "{{ networking_homepage.log_level | default('info') }}"
    homepage_nginx_path: "{{ networking_homepage.nginx_path | default('/') }}"
    nginx_sites_available: "{{ networking_nginx.sites_available_dir }}"
    nginx_sites_enabled: "{{ networking_nginx.sites_enabled_dir }}"
    nginx_sites_location: "{{ networking_nginx.sites_location_dir }}"
    nginx_tls_dir: "/etc/nginx/tls"
    nginx_server_name: "{{ networking_nginx.hostname }}"
    nginx_systemd_name: "nginx"
  tags: [always]

- name: Set Homepage Docker file facts for the role
  ansible.builtin.set_fact:
    homepage_config_file: "{{ homepage_install_dir }}/.env"
    homepage_compose_file: "{{ homepage_install_dir }}/compose.yaml"
  tags: [always]

- name: Debug all Homepage Docker facts
  ansible.builtin.debug:
    msg: |
      Homepage Docker facts:
      - User: {{ homepage_user }}
      - Group: {{ homepage_group }}
      - Additional Groups: {{ homepage_groups_additional | join(', ') }}
      - Port: {{ homepage_port }}
      - Install Dir: {{ homepage_install_dir }}
      - Data Dir: {{ homepage_data_dir }}
      - Config Dir: {{ homepage_config_dir }}
      - Config File: {{ homepage_config_file }}
      - Compose File: {{ homepage_compose_file }}
      - Allowed Networks: {{ homepage_allowed_networks }}
      - Nginx Enabled: {{ homepage_nginx_enabled }}
      - Image: {{ homepage_image }}
      - Image Tag: {{ homepage_image_tag }}
      - Container Name: {{ homepage_container_name }}
      - Timezone: {{ homepage_timezone }}
      - Hostname: {{ homepage_hostname }}
      - Title: {{ homepage_title }}
      - Description: {{ homepage_description }}
      - Theme: {{ homepage_theme }}
      - Allowed Hosts: {{ homepage_allowed_hosts }}
      - Log Level: {{ homepage_log_level }}
  tags: [debug]


## Create user and group for Homepage Docker
# -----------------------------------------------------------------------------

- name: Create Homepage Docker system user and group
  ansible.builtin.group:
    name: "{{ homepage_group }}"
    state: present
    system: true
  become: true
  tags: [install, config]

- name: Create Homepage Docker system user
  ansible.builtin.user:
    name: "{{ homepage_user }}"
    group: "{{ homepage_group }}"
    system: true
    shell: /usr/sbin/nologin
    home: "{{ homepage_data_dir }}"
    create_home: false
    groups: "{{ homepage_groups_additional | join(',') }}"
  become: true
  tags: [install, config]


## Install Docker and dependencies
# -----------------------------------------------------------------------------

- name: Assert Docker service is running
  ansible.builtin.systemd:
    name: docker
    state: started
  become: true
  register: docker_start
  tags: [install]

- name: Fail if Docker could not be started
  ansible.builtin.fail:
    msg: "Docker service is not running and could not be started. Please check Docker installation and system logs."
  when: docker_start.failed
  tags: [install]

- name: Install Homepage package dependencies
  ansible.builtin.apt:
    name:
      - curl
    state: present
    update_cache: true
  become: true
  tags: [install]


## Create Homepage Docker directories
# -----------------------------------------------------------------------------

- name: Create Homepage Docker directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ homepage_user }}"
    group: "{{ homepage_group }}"
    mode: '0755'
  loop:
    - "{{ homepage_install_dir }}"
    - "{{ homepage_data_dir }}"
    - "{{ homepage_config_dir }}"
  become: true
  tags: [install, config]


## Deploy Homepage Docker Compose
# -----------------------------------------------------------------------------

- name: Deploy Homepage Docker Compose file
  ansible.builtin.template:
    src: templates/homepage-docker-compose.yml.j2
    dest: "{{ homepage_compose_file }}"
    owner: "{{ homepage_user }}"
    group: "{{ homepage_group }}"
    mode: '0644'
  become: true
  notify: Restart Homepage Docker
  tags: [install, config]

- name: Pull Homepage Docker image
  community.docker.docker_image:
    name: "{{ homepage_image }}"
    source: pull
    state: present
  become: true
  tags: [install, update]

- name: Create Homepage Docker network
  community.docker.docker_network:
    name: homepage_network
    driver: bridge
    state: present
  become: true
  tags: [install, config]


## Deploy Homepage Docker environment file
# -----------------------------------------------------------------------------

- name: Deploy Homepage environment file
  ansible.builtin.template:
    src: templates/homepage-docker.env.j2
    dest: "{{ homepage_config_file }}"
    owner: "{{ homepage_user }}"
    group: "{{ homepage_group }}"
    mode: '0644'
  become: true
  notify: Restart Homepage Docker
  tags: [install, config]


## Start Homepage Docker container
# -----------------------------------------------------------------------------

- name: Verify Homepage Docker Compose file exists
  ansible.builtin.stat:
    path: "{{ homepage_install_dir }}"
  register: homepage_compose_stat
  tags: [verify]

- name: Display Homepage Docker Compose file status
  ansible.builtin.debug:
    msg: "Homepage Docker Compose file {{ 'exists' if homepage_compose_stat.stat.exists else 'does not exist' }} at {{ homepage_compose_file }}"
  tags: [debug]

- name: Stop Homepage Docker container before starting
  community.docker.docker_compose:
    project_src: "{{ homepage_install_dir }}"
    state: absent
  become: true
  tags: [install, config]

- name: Start Homepage Docker container
  community.docker.docker_compose:
    project_src: "{{ homepage_install_dir }}"
    state: present
    remove_orphans: true
  become: true
  register: homepage_result
  tags: [install, config]

- name: Display Homepage Docker deployment result
  ansible.builtin.debug:
    msg: "{{ homepage_result }}"
  when: homepage_result is defined
  tags: [debug]


## Configure UFW firewall
# -----------------------------------------------------------------------------

- name: Deploy Homepage Docker UFW application profile
  ansible.builtin.template:
    src: templates/homepage-ufw-profile.j2
    dest: /etc/ufw/applications.d/homepage
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Reload UFW
  tags: [install, config, firewall]

- name: Reload UFW to recognize new application profile
  community.general.ufw:
    state: reloaded
  become: true
  tags: [install, config]

- name: Allow Homepage through UFW from allowed networks
  ansible.builtin.ufw:
    rule: allow
    name: "Homepage Dashboard"
    comment: "Allow Homepage Dashboard ({{ homepage_port }}/tcp) from LOCAL NET"
    src: "{{ item }}"
  loop: "{{ homepage_allowed_networks }}"
  become: true
  tags: [install, config, firewall]


## Configure Nginx reverse proxy
# -----------------------------------------------------------------------------

- name: Deploy Homepage Docker Nginx location block
  ansible.builtin.template:
    src: templates/homepage-nginx-location.j2
    dest: "/etc/nginx/conf.d/{{ networking_nginx.hostname }}-homepage.conf"
    owner: root
    group: root
    mode: '0644'
  vars:
    homepage_port: "{{ homepage_port }}"
  become: true
  notify: Reload Nginx
  when: homepage_nginx_enabled
  tags: [install, config, nginx]

- name: Deploy new default site with homepage root
  when: homepage_nginx_root_enabled
  ansible.builtin.template:
    src: "templates/homepage-nginx-server.conf.j2"
    dest: "{{ nginx_sites_available }}/{{ nginx_server_name }}-server.conf"
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Reload Nginx
  tags: [install, config, nginx]

# ## Health checks and verification
# # -----------------------------------------------------------------------------

# - name: Wait for Homepage to be ready
#   ansible.builtin.uri:
#     url: "http://127.0.0.1:{{ homepage_port }}/"
#     method: GET
#     status_code: 200
#   register: homepage_health_check
#   until: homepage_health_check.status == 200
#   retries: 30
#   delay: 10
#   when: homepage_result.changed
#   tags: [install, config, verify, healthcheck]

# - name: Display Homepage health check result
#   ansible.builtin.debug:
#     msg: "Homepage is healthy and responding on port {{ homepage_port }}"
#   when: homepage_health_check.status == 200
#   tags: [install, config, verify, healthcheck]

# - name: Verify Homepage container is running
#   community.docker.docker_container_info:
#     name: "{{ homepage_container_name }}"
#   register: homepage_container_info
#   become: true
#   tags: [install, config, verify, healthcheck]

# - name: Display Homepage container status
#   ansible.builtin.debug:
#     msg: |
#       Homepage container status: {{ homepage_container_info.container.State.Status }}
#       Container ID: {{ homepage_container_info.container.Id[:12] }}
#       Image: {{ homepage_container_info.container.Image }}
#       Ports: {{ homepage_container_info.container.NetworkSettings.Ports }}
#   tags: [install, config, verify, healthcheck]


# ## Post-installation information
# # -----------------------------------------------------------------------------

# - name: Display Homepage installation summary
#   ansible.builtin.debug:
#     msg: |
#       Homepage Dashboard has been successfully installed!

#       Access URLs:
#       {% if homepage_nginx_enabled %}
#       - Via Nginx: https://{{ networking_nginx.hostname }}/
#       {% endif %}
#       - Direct: http://{{ ansible_hostname }}:{{ homepage_port }}

#       Configuration:
#       - Container: {{ homepage_container_name }}
#       - Data directory: {{ homepage_data_dir }}
#       - Config directory: {{ homepage_config_dir }}
#       - Port: {{ homepage_port }}

#       Next steps:
#       1. Access Homepage web interface
#       2. Configure your dashboard widgets
#       3. Add integrations for your services
#       4. Customize the layout and appearance
#   tags: [install, summary]


# ## Uninstall Homepage
# # -----------------------------------------------------------------------------

# - name: Stop and remove Homepage Docker container
#   community.docker.docker_container:
#     name: "{{ homepage_container_name }}"
#     state: absent
#   become: true
#   tags: [never, uninstall]

# - name: Remove Homepage Docker network
#   community.docker.docker_network:
#     name: homepage_network
#     state: absent
#   become: true
#   tags: [never, uninstall]

# - name: Remove Homepage Docker image
#   community.docker.docker_image:
#     name: "{{ homepage_image }}"
#     state: absent
#   become: true
#   tags: [never, uninstall]

# - name: Remove Homepage directories
#   ansible.builtin.file:
#     path: "{{ item }}"
#     state: absent
#   loop:
#     - "{{ homepage_install_dir }}"
#     - "{{ homepage_data_dir }}"
#     - "{{ homepage_config_dir }}"
#   become: true
#   tags: [never, uninstall]

# - name: Remove Homepage Nginx location block
#   ansible.builtin.file:
#     path: "/etc/nginx/conf.d/{{ networking_nginx.hostname }}-homepage.conf"
#     state: absent
#   become: true
#   notify: Reload Nginx
#   when: homepage_nginx_enabled
#   tags: [never, uninstall]

# - name: Remove Homepage UFW application profile
#   ansible.builtin.file:
#     path: /etc/ufw/applications.d/homepage
#     state: absent
#   become: true
#   notify: Reload UFW
#   tags: [never, uninstall]

# - name: Remove Homepage UFW rules
#   community.general.ufw:
#     rule: allow
#     name: "Homepage"
#     src: "{{ item }}"
#     delete: yes
#   loop: "{{ homepage_allowed_networks }}"
#   become: true
#   tags: [uninstall, firewall]

# - name: Remove Homepage system user
#   ansible.builtin.user:
#     name: "{{ homepage_user }}"
#     state: absent
#     remove: true
#   become: true
#   tags: [never, uninstall]

# - name: Remove Homepage system group
#   ansible.builtin.group:
#     name: "{{ homepage_group }}"
#     state: absent
#   become: true
#   tags: [never, uninstall]

# - name: Display Homepage uninstall summary
#   ansible.builtin.debug:
#     msg: |
#       Homepage Dashboard has been successfully uninstalled!

#       Removed:
#       - Docker container and network
#       - Docker image
#       - Configuration and data directories
#       - Nginx configuration
#       - UFW firewall rules
#       - System user and group
#   tags: [never, uninstall]
