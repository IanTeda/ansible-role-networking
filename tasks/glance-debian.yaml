# =============================================================================
# Ansible Role: Networking - Glance Dashboard Installation (Debian)
# =============================================================================
#
# This file contains tasks for installing Glance Dashboard on Debian-based systems.
# Glance is a beautiful dashboard for self-hosted services and applications.
#
# Features:
#   - Native Debian installation
#   - Web-based dashboard interface
#   - Configurable server settings
#   - Firewall configuration for secure access
#   - Nginx reverse proxy integration
#   - Alloy monitoring integration
#
# Requirements:
#   - Debian/Ubuntu system
#   - Internet connectivity
#   - Root/sudo access
#   - Python 3 and pip
#
# Author: IanTeda
# =============================================================================

## Glance Role Variables and Facts
# -----------------------------------------------------------------------------

- name: Display Glance variables for debugging
  ansible.builtin.debug:
    var: networking_glance
  tags: [debug]

- name: Set Glance facts for the role
  ansible.builtin.set_fact:
    glance_user: "{{ networking_glance.user | default('glance') }}"
    glance_group: "{{ networking_glance.group | default('glance') }}"
    glance_web_port: "{{ networking_glance.web_port | default('8080') }}"
    glance_config_dir: "{{ networking_glance.config_dir | default('/var/lib/glance') }}"
    glance_allowed_networks: "{{ networking_glance.allowed_networks | default('192.168.1.0/255.255.255.0') }}"
    glance_server_name: "{{ networking_glance.server_name | default('Glance Dashboard') }}"
  tags: [always]


## Create user and group for Glance
# -----------------------------------------------------------------------------

- name: Create Glance system user and group
  ansible.builtin.group:
    name: "{{ glance_group }}"
    state: present
    system: true
  become: true
  tags: [install, config]

- name: Create Glance system user
  ansible.builtin.user:
    name: "{{ glance_user }}"
    group: "{{ glance_group }}"
    system: true
    shell: /usr/sbin/nologin
    home: "{{ glance_config_dir }}"
    create_home: false
  become: true
  tags: [install, config]


## Install Glance
# -----------------------------------------------------------------------------

- name: Install required dependencies
  ansible.builtin.apt:
    name:
      - python3
      - python3-pip
      - python3-dev
      - git
      - curl
      - sqlite3
    state: present
    update_cache: true
  become: true
  tags: [install]

- name: Install Python requirements for Glance
  ansible.builtin.pip:
    name:
      - flask
      - requests
      - gunicorn
      - beautifulsoup4
    state: present
    executable: pip3
  become: true
  tags: [install]

- name: Clone Glance repository
  ansible.builtin.git:
    repo: https://github.com/glanceapp/glance.git
    dest: "{{ glance_config_dir }}/glance"
    version: main
    update: true
  become: true
  become_user: "{{ glance_user }}"
  tags: [install]

- name: Create Glance directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ glance_user }}"
    group: "{{ glance_group }}"
    mode: '0755'
  loop:
    - "{{ glance_config_dir }}"
    - "{{ glance_config_dir }}/logs"
  become: true
  tags: [install, config]

- name: Create Glance configuration file
  ansible.builtin.template:
    src: glance-config.yml.j2
    dest: "{{ glance_config_dir }}/config.yml"
    owner: "{{ glance_user }}"
    group: "{{ glance_group }}"
    mode: '0644'
  become: true
  tags: [install, config]


## Configure Glance
# -----------------------------------------------------------------------------

- name: Configure Glance service
  ansible.builtin.template:
    src: templates/glance.service.j2
    dest: /etc/systemd/system/glance.service
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: restart glance
  tags: [install, config]

- name: Reload systemd daemon
  ansible.builtin.systemd:
    daemon_reload: true
  become: true
  tags: [install, config]


## Start and enable Glance service
# -----------------------------------------------------------------------------

- name: Enable and start Glance service
  ansible.builtin.systemd:
    name: glance
    enabled: true
    state: started
  become: true
  tags: [install]

- name: Wait for Glance web UI to be fully started
  ansible.builtin.wait_for:
    port: "{{ glance_web_port }}"
    timeout: 120
  become: true
  tags: [install]


## Configure Firewall for Glance
# -----------------------------------------------------------------------------

- name: Deploy Glance UFW application profile
  ansible.builtin.template:
    src: templates/glance-ufw-profile.j2
    dest: /etc/ufw/applications.d/glance
    owner: root
    group: root
    mode: '0644'
  become: true
  tags: [install, config, firewall]

- name: Allow Glance access from allowed networks
  community.general.ufw:
    rule: allow
    name: Glance
    from_ip: "{{ item }}"
  loop: "{{ glance_allowed_networks.split(',') | map('trim') | list }}"
  become: true
  tags: [install, config, firewall]

- name: Reload UFW to recognize new application profile
  community.general.ufw:
    state: reloaded
  become: true
  tags: [install, config, firewall]


## Configure Nginx Location Block for Glance
# -----------------------------------------------------------------------------

- name: Deploy Glance Nginx location block
  ansible.builtin.template:
    src: templates/glance-nginx-location.j2
    dest: "/etc/nginx/conf.d/glance-location.conf"
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: reload nginx
  tags: [install, config, nginx]

- name: Test Nginx configuration
  ansible.builtin.command: nginx -t
  become: true
  tags: [install, config, nginx]


## Configure Alloy Monitoring for Glance
# -----------------------------------------------------------------------------

- name: Deploy Glance Alloy configuration block
  ansible.builtin.template:
    src: templates/glance-alloy-block.alloy.j2
    dest: "/etc/alloy/glance.alloy"
    owner: root
    group: root
    mode: '0644'
  become: true
  tags: [install, config, monitoring]

- name: Add Glance Alloy import to main config
  ansible.builtin.lineinfile:
    path: "/etc/alloy/config.alloy"
    line: 'import "apps/glance.alloy"'
    state: present
    create: false
  become: true
  tags: [install, config, monitoring]

- name: Reload Alloy service to pick up new configuration
  ansible.builtin.systemd:
    name: alloy
    state: reloaded
  become: true
  tags: [install, config, monitoring]


## Verify Glance Installation
# -----------------------------------------------------------------------------

- name: Verify UFW is enabled and active
  ansible.builtin.command: ufw status
  register: ufw_status
  changed_when: false
  become: true
  tags: [verify, firewall]

- name: Display UFW status
  ansible.builtin.debug:
    msg: "{{ ufw_status.stdout_lines }}"
  tags: [verify, firewall]

- name: Verify Glance UFW application profile exists
  ansible.builtin.stat:
    path: /etc/ufw/applications.d/glance
  register: glance_profile_stat
  become: true
  tags: [verify, firewall]

- name: Confirm Glance application profile installation
  ansible.builtin.debug:
    msg: "Glance UFW application profile is {{ 'installed' if glance_profile_stat.stat.exists else 'missing' }}"
  tags: [verify, firewall]

- name: Check Glance application rules in UFW
  ansible.builtin.shell: |
    echo "=== Glance Rules ==="
    ufw status | grep -i glance || echo "No Glance rules found"
  register: glance_rules
  changed_when: false
  become: true
  tags: [verify, firewall]

- name: Display Glance UFW rules
  ansible.builtin.debug:
    msg: |
      Glance UFW Rules:
      {{ glance_rules.stdout }}
  tags: [verify, firewall]

- name: Test Glance web UI port accessibility from localhost
  ansible.builtin.wait_for:
    host: 127.0.0.1
    port: "{{ glance_web_port }}"
    timeout: 5
  ignore_errors: true
  register: glance_web_test
  tags: [verify]

- name: Report Glance web UI local connectivity
  ansible.builtin.debug:
    msg: "Glance web UI port {{ glance_web_port }} is {{ 'accessible' if glance_web_test.elapsed < 5 else 'not accessible' }} from localhost"
  tags: [verify]

- name: Verify Glance service is running
  ansible.builtin.systemd:
    name: glance
  register: glance_service_status
  become: true
  tags: [verify]

- name: Display Glance service status
  ansible.builtin.debug:
    msg: "Glance service status: {{ glance_service_status }}"
  tags: [verify]

- name: Verify Glance configuration directory exists
  ansible.builtin.stat:
    path: "{{ glance_config_dir }}"
  register: glance_config_stat
  become: true
  tags: [verify]

- name: Confirm Glance configuration directory
  ansible.builtin.debug:
    msg: "Glance config directory {{ glance_config_dir }} {{ 'exists' if glance_config_stat.stat.exists else 'does not exist' }}"
  tags: [verify]

- name: Verify Glance Nginx location block exists
  ansible.builtin.stat:
    path: /etc/nginx/conf.d/glance-location.conf
  register: glance_nginx_stat
  tags: [verify, nginx]

- name: Confirm Glance Nginx location block installation
  ansible.builtin.debug:
    msg: "Glance Nginx location block is {{ 'installed' if glance_nginx_stat.stat.exists else 'missing' }}"
  tags: [verify, nginx]
