# ============================================================================
# Ansible Task File: nfs-mounts-debian.yaml
# ----------------------------------------------------------------------------
# This file is managed by Ansible. Manual changes may be overwritten!
#
# Purpose: Complete automation of NFSv3 share mounting on Debian-based systems,
# including package installation, fstab configuration, mount management,
# permissions setup, and health checks.
#
# NFS Version: 3 (as requested)
# Compatible with: Debian 12 (Bookworm) and similar
#
# Managed by: roles/networking/tasks/nfs-mounts-debian.yaml
# Project: ansible_playbook
# Maintainer: IanTeda
# ============================================================================


## 00. SET NFS ANSIBLE FACTS
# -----------------------------------------------------------------------------

- name: Display NFS variables for debugging
  ansible.builtin.debug:
    var: networking_nfs
  tags: [debug]

- name: Set NFS facts for the role
  ansible.builtin.set_fact:
    nfs_default_options: "{{ networking_nfs.options }}"
    nfs_mounts: "{{ networking_nfs.mounts }}"
    nfs_user: "{{ networking_nfs.user | default('root') }}"
    nfs_group: "{{ networking_nfs.group | default('root') }}"
    nfs_method: "{{ networking_nfs.method | default('fstab') }}"
  tags: [always]

# - name: Display NFS facts for debugging
#   ansible.builtin.debug:
#     msg:
#       - "Fact -> nfs_enabled: {{ nfs_enabled }}"
#       - "Fact -> nfs_version: {{ nfs_version }}"
#       - "Fact -> nfs_mounts: {{ nfs_mounts | length }} configured"
#   tags: [debug]

- name: Confirm NFS mount removal
  ansible.builtin.pause:
    prompt: |
      âš ï¸  WARNING: NFS Mount Removal Confirmation âš ï¸

      You are about to remove all NFS mounts configured for this system.

      This will:
      ðŸ—‘ï¸  Unmount all NFS shares
      ðŸ—‘ï¸  Remove NFS mount entries from /etc/fstab
      ðŸ—‘ï¸  Remove mount point directories
      ðŸ—‘ï¸  Remove NFS client packages

      Are you sure you want to proceed with the NFS mount removal? (yes/no)
  register: nfs_removal_confirmation
  tags: [never, uninstall]

- name: Aborted NFS mount removal
  ansible.builtin.fail:
    msg: |
      ðŸ›‘ NFS mount removal aborted by user choice

      The NFS mounts remain configured and operational.
      No changes have been made to the system.
  when: not (nfs_removal_confirmation.user_input | bool)
  tags: [never, uninstall]


## 01. INSTALL NFS CLIENT PACKAGES
# -----------------------------------------------------------------------------
- name: Install NFS client packages
  ansible.builtin.apt:
    name:
      - nfs-common
      - rpcbind
    state: present
    update_cache: true
  become: true
  tags: [install]

- name: Ensure rpcbind service is running and enabled
  ansible.builtin.systemd:
    name: rpcbind
    state: started
    enabled: true
  become: true
  tags: [install]


## 02. CREATE MOUNT DIRECTORIES
# -----------------------------------------------------------------------------
- name: Ensure NFS group "{{ nfs_group }}" exists
  ansible.builtin.group:
    name: "{{ nfs_group }}"
    state: present
  become: true
  tags: [install]

- name: Ensure NFS user "{{ nfs_user }}" exists
  ansible.builtin.user:
    name: "{{ nfs_user }}"
    system: true
    create_home: false
    shell: /bin/bash
    comment: "NFS User Account"
  become: true
  tags: [install]

- name: Ensure default user is in NFS group
  ansible.builtin.user:
    name: "{{ vault_default_user_name | default(ansible_user) }}"
    groups: "{{ nfs_group }}"
    append: true
  become: true
  tags: [install, config]

- name: Create NFS mount directories
  ansible.builtin.file:
    path: "{{ item.mount_path }}"
    state: directory
    owner: "{{ nfs_user }}"
    group: "{{ nfs_group }}"
    mode: "{{ item.mode | default('0755') }}"
  loop: "{{ nfs_mounts }}"
  become: true
  tags: [install, config]


- name: Configure and mount fstab entries
  tags: [install, config]
  when: nfs_method == "fstab"
  block:

    ## CONFIGURE FSTAB ENTRIES
    # -----------------------------------------------------------------------------
    - name: Add NFS mounts to /etc/fstab
      ansible.builtin.mount:
        path: "{{ item.mount_path }}"
        src: "{{ item.server }}:{{ item.share_path }}"
        fstype: nfs
        opts: "{{ nfs_default_options }}"
        state: present
        boot: yes
      loop: "{{ nfs_mounts }}"
      become: true
      tags: [install, config]

    - name: Reload systemd daemon after fstab changes
      ansible.builtin.systemd:
        daemon_reload: yes
      become: true
      tags: [install, config]

    ## MOUNT NFS SHARES
    # -----------------------------------------------------------------------------
    - name: Mount NFS shares
      ansible.builtin.command:
        cmd: "mount {{ item.mount_path }}"
      loop: "{{ nfs_mounts }}"
      register: mount_results
      changed_when: mount_results.rc == 0
      failed_when: mount_results.rc != 0
      become: true
      tags: [install, config]

    - name: Verify NFS mounts are active
      ansible.builtin.shell:
        cmd: "mount | grep '{{ item.mount_path }}'"
      loop: "{{ nfs_mounts }}"
      register: mount_verify
      changed_when: false
      failed_when: mount_verify.rc != 0
      become: true
      tags: [install, config, verify]


- name: Uninstall mount fstab entries
  tags: [never, uninstall]
  when: nfs_method == "fstab"
  block:

    ## UNINSTALLATION FSTAB TASKS
    # -----------------------------------------------------------------------------
    - name: Unmount NFS shares before removal
      ansible.builtin.command:
        cmd: "umount {{ item.mount_path }}"
      loop: "{{ nfs_mounts }}"
      register: umount_results
      changed_when: umount_results.rc == 0
      failed_when: false  # Don't fail if already unmounted
      become: true
      when: (nfs_removal_confirmation.user_input | bool) and (nfs_method == "fstab")
      tags: [never, uninstall]

    - name: Remove NFS mount entries from /etc/fstab
      ansible.builtin.mount:
        path: "{{ item.mount_path }}"
        src: "{{ item.server }}:{{ item.share_path }}"
        fstype: nfs
        state: absent
      loop: "{{ nfs_mounts }}"
      become: true
      when: (nfs_removal_confirmation.user_input | bool) and (nfs_method == "fstab")
      tags: [never, uninstall]

    - name: Stop and disable rpcbind service
      ansible.builtin.systemd:
        name: rpcbind
        state: stopped
        enabled: false
      become: true
      when: nfs_removal_confirmation.user_input | bool
      tags: [never, uninstall]


## DEPLOY SYSTEMD MOUNT FILES
# -------------------------------------------------------------------------
- name: Configure and mount systemd mount
  tags: [install, config]
  when: nfs_method == "systemd"
  block:

    - name: Create systemd mount unit files for NFS shares
      ansible.builtin.template:
        src: nfs-systemd.mount.j2
        dest: "/etc/systemd/system/{{ item.mount_path[1:] | replace('/', '-') }}.mount"
        owner: root
        group: root
        mode: '0644'
      loop: "{{ nfs_mounts }}"
      become: true
      tags: [install, config]

    - name: Reload systemd daemon after mount unit changes
      ansible.builtin.systemd:
        daemon_reload: yes
      become: true
      tags: [install, config]

    - name: Enable and start systemd mount units
      ansible.builtin.systemd:
        name: "{{ item.mount_path[1:] | replace('/', '-') }}.mount"
        state: started
        enabled: true
      loop: "{{ nfs_mounts }}"
      become: true
      tags: [install, config]

    - name: Confirm NFS systemd mount units are active
      ansible.builtin.systemd:
        name: "{{ item.mount_path[1:] | replace('/', '-') }}.mount"
        state: started
      loop: "{{ nfs_mounts }}"
      become: true
      tags: [install, config, verify]

    - name: Verify NFS systemd mounts are mounted
      ansible.builtin.shell:
        cmd: "mount | grep '{{ item.mount_path }}'"
      loop: "{{ nfs_mounts }}"
      register: systemd_mount_verify
      changed_when: false
      failed_when: systemd_mount_verify.rc != 0
      become: true
      tags: [install, config, verify]



- name: Uninstall systemd mounts
  tags: [never, uninstall]
  when: nfs_method == "systemd"
  block:

    ## UNINSTALL SYSTEMD MOUNTS
    # -------------------------------------------------------------------------
    - name: Stop and disable systemd mount units
      ansible.builtin.systemd:
        name: "{{ item.name }}.mount"
        state: stopped
        enabled: false
      loop: "{{ nfs_mounts }}"
      become: true
      tags: [never, uninstall]

    - name: Remove systemd mount unit files
      ansible.builtin.file:
        path: "/etc/systemd/system/{{ item.name }}.mount"
        state: absent
      loop: "{{ nfs_mounts }}"
      become: true
      tags: [never, uninstall]

    - name: Reload systemd daemon after mount unit removal
      ansible.builtin.systemd:
        daemon_reload: yes
      become: true
      tags: [never, uninstall]



## 05. SET MOUNT PERMISSIONS
# -----------------------------------------------------------------------------
- name: Set permissions on mounted NFS shares
  ansible.builtin.file:
    path: "{{ item.mount_path }}"
    owner: "{{ nfs_user }}"
    group: "{{ nfs_group }}"
    mode: "{{ item.mode | default('0755') }}"
    state: directory
  loop: "{{ nfs_mounts }}"
  become: true
  tags: [install, config]


## 06. HEALTH CHECKS AND VERIFICATION
# -----------------------------------------------------------------------------
- name: Test NFS mount accessibility
  ansible.builtin.shell:
    cmd: "ls -la {{ item.mount_path }} | head -5"
  loop: "{{ nfs_mounts }}"
  register: nfs_access_test
  changed_when: false
  failed_when: nfs_access_test.rc != 0
  become: true
  tags: [install, config, verify, healthcheck]

- name: Check NFS mount details
  ansible.builtin.command:
    cmd: "df -h {{ item.mount_path }}"
  loop: "{{ nfs_mounts }}"
  register: nfs_df_check
  changed_when: false
  failed_when: nfs_df_check.rc != 0
  become: true
  tags: [install, config, verify, healthcheck]

- name: Verify NFS server connectivity
  ansible.builtin.command:
    cmd: "showmount -e {{ item.server }}"
  loop: "{{ nfs_mounts }}"
  register: nfs_showmount
  changed_when: false
  failed_when: false  # Don't fail if showmount is not available on server
  become: true
  tags: [install, config, verify, healthcheck]

- name: Test NFS mount write permissions
  ansible.builtin.shell:
    cmd: |
      TEST_FILE="{{ item.mount_path }}/.nfs-healthcheck-{{ ansible_date_time.epoch }}.test"
      echo "NFS Health Check - {{ ansible_date_time.iso8601 }}" > "$TEST_FILE"
      if [ $? -eq 0 ]; then
        echo "Write test successful for {{ item.mount_path }}"
        rm "$TEST_FILE"
        if [ $? -eq 0 ]; then
          echo "Remove test successful for {{ item.mount_path }}"
          exit 0
        else
          echo "Remove test failed for {{ item.mount_path }}"
          exit 1
        fi
      else
        echo "Write test failed for {{ item.mount_path }}"
        exit 1
      fi
  loop: "{{ nfs_mounts }}"
  register: nfs_write_test
  changed_when: false
  failed_when: nfs_write_test.rc != 0
  become: true
  become_user: "{{ nfs_user }}"
  tags: [install, config, verify, healthcheck]


## 07. DISPLAY NFS MOUNT INFORMATION
# -----------------------------------------------------------------------------
- name: Display NFS mount configuration summary
  ansible.builtin.shell: |
    echo "âœ… NFS Configuration Summary:"
    echo ""
    echo "Total Mounts: {{ nfs_mounts | length }}"
    echo ""
    {% for mount in nfs_mounts %}
    echo "Mount {{ loop.index }}:"
    echo "  Server: {{ mount.server }}"
    echo "  Share: {{ mount.share_path }}"
    echo "  Mount Point: {{ mount.mount_path }}"
    echo "  Options: {{ mount.options | default(nfs_default_options) }}"
    echo "  Owner: {{ mount.owner | default('root') }}:{{ mount.group | default('root') }}"
    echo "  Mode: {{ mount.mode | default('0755') }}"
    echo ""
    {% endfor %}
  register: nfs_summary
  changed_when: false
  tags: [install, config, verify]

- name: Print NFS mount configuration summary
  ansible.builtin.debug:
    msg: "{{ item }}"
  loop: "{{ nfs_summary.stdout_lines }}"
  tags: [install, config, verify]


## 08. UNINSTALLATION TASKS
# -----------------------------------------------------------------------------
- name: Unmount NFS shares before removal
  ansible.builtin.command:
    cmd: "umount {{ item.mount_path }}"
  loop: "{{ nfs_mounts }}"
  register: umount_results
  changed_when: umount_results.rc == 0
  failed_when: false  # Don't fail if already unmounted
  become: true
  when: nfs_removal_confirmation.user_input | bool
  tags: [never, uninstall]

- name: Remove NFS mount entries from /etc/fstab
  ansible.builtin.mount:
    path: "{{ item.mount_path }}"
    src: "{{ item.server }}:{{ item.share_path }}"
    fstype: nfs
    state: absent
  loop: "{{ nfs_mounts }}"
  become: true
  when: nfs_removal_confirmation.user_input | bool
  tags: [never, uninstall]

- name: Remove NFS mount directories
  ansible.builtin.file:
    path: "{{ item.mount_path }}"
    state: absent
  loop: "{{ nfs_mounts }}"
  become: true
  when: nfs_removal_confirmation.user_input | bool
  tags: [never, uninstall]

- name: Remove NFS client packages
  ansible.builtin.apt:
    name:
      - nfs-common
      - rpcbind
    state: absent
    purge: true
  become: true
  when: nfs_removal_confirmation.user_input | bool
  tags: [never, uninstall]

- name: Stop and disable rpcbind service
  ansible.builtin.systemd:
    name: rpcbind
    state: stopped
    enabled: false
  become: true
  when: nfs_removal_confirmation.user_input | bool
  tags: [never, uninstall]
