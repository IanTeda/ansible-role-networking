# =============================================================================
# Ansible Role: Networking - Homarr Dashboard Docker Installation
# =============================================================================
#
# This file contains tasks for installing Homarr Dashboard using Docker on Debian-based systems.
# Homarr is a customizable home page / application dashboard with integrations
# for various services and applications.
#
# Features:
#   - Customizable widgets and layouts
#   - Docker container management
#   - Persistent configuration storage
#   - Nginx reverse proxy configuration
#   - UFW firewall rules
#
# Requirements:
#   - Debian/Ubuntu system with Docker installed
#   - Internet connectivity
#   - Root/sudo access
#   - Nginx role configured (for reverse proxy)
#
# Author: Generated by Ansible
# =============================================================================

## Homarr Docker Role Variables and Facts
# -----------------------------------------------------------------------------

- name: Display Homarr Docker variables for debugging
  ansible.builtin.debug:
    var: networking_homarr
  tags: [debug]

- name: Set Homarr Docker facts for the role
  ansible.builtin.set_fact:
    homarr_user: "{{ networking_homarr.user | default('homarr') }}"
    homarr_group: "{{ networking_homarr.group | default('homarr') }}"
    homarr_group_additional: "{{ networking_homarr.additional_groups | default([]) }}"
    homarr_web_port: "{{ networking_homarr.web_port | default('7575') }}"
    homarr_install_dir: "{{ networking_homarr.install_dir | default('/opt/homarr') }}"
    homarr_data_dir: "{{ networking_homarr.data_dir | default('/var/lib/homarr') }}"
    homarr_config_dir: "{{ networking_homarr.config_dir | default('/etc/homarr') }}"
    homarr_allowed_networks: "{{ networking_homarr.allowed_networks | default(['192.168.1.0/24']) }}"
    homarr_nginx_enabled: "{{ networking_homarr.nginx_enabled | default(true) }}"
    homarr_image: "{{ networking_homarr.docker_image | default('ghcr.io/ajnart/homarr') }}"
    homarr_image_tag: "{{ networking_homarr.docker_image_tag | default('latest') }}"
    homarr_container_name: "{{ networking_homarr.container_name | default('homarr') }}"
    homarr_timezone: "{{ networking_homarr.timezone | default('America/New_York') }}"
    homarr_auth_secret: "{{ networking_homarr.auth_secret | default('super-secret-auth') }}"
  tags: [always]

- name: Set Homarr Docker file facts for the role
  ansible.builtin.set_fact:
    homarr_config_file: "{{ homarr_config_dir }}/homarr.conf"
  tags: [always]


## Create user and group for Homarr Docker
# -----------------------------------------------------------------------------

- name: Create Homarr Docker system user and group
  ansible.builtin.group:
    name: "{{ homarr_group }}"
    state: present
    system: true
  become: true
  tags: [install, config]

- name: Create Homarr Docker system user
  ansible.builtin.user:
    name: "{{ homarr_user }}"
    group: "{{ homarr_group }}"
    system: true
    shell: /usr/sbin/nologin
    home: "{{ homarr_data_dir }}"
    create_home: false
    groups: "{{ homarr_group_additional | join(',') }}"
  become: true
  when: homarr_group_additional | length > 0
  tags: [install, config]


## Install Docker and dependencies
# -----------------------------------------------------------------------------

- name: Assert Docker service is running
  ansible.builtin.systemd:
    name: docker
    state: started
  become: true
  register: docker_start
  tags: [install]

- name: Fail if Docker could not be started
  ansible.builtin.fail:
    msg: "Docker service is not running and could not be started. Please check Docker installation and system logs."
  when: docker_start.failed
  tags: [install]

- name: Install Homarr package dependencies
  ansible.builtin.apt:
    name:
      - netcat-openbsd
    state: present
    update_cache: true
  become: true
  tags: [install]


## Create Homarr Docker directories
# -----------------------------------------------------------------------------

- name: Create Homarr Docker directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: directory
    owner: "{{ homarr_user }}"
    group: "{{ homarr_group }}"
    mode: '0755'
  loop:
    - "{{ homarr_install_dir }}"
    - "{{ homarr_data_dir }}"
    - "{{ homarr_config_dir }}"
  become: true
  tags: [install, config]


## Deploy Homarr Docker Compose
# -----------------------------------------------------------------------------

- name: Deploy Homarr Docker Compose file
  ansible.builtin.template:
    src: templates/homarr-docker-compose.yml.j2
    dest: "{{ homarr_install_dir }}/docker-compose.yml"
    owner: "{{ homarr_user }}"
    group: "{{ homarr_group }}"
    mode: '0644'
  become: true
  notify: Restart Homarr Docker
  tags: [install, config]

- name: Pull Homarr Docker image
  community.docker.docker_image:
    name: "{{ homarr_image }}"
    source: pull
    state: present
  become: true
  tags: [install, update]

- name: Create Homarr Docker network
  community.docker.docker_network:
    name: homarr_network
    driver: bridge
    state: present
  become: true
  tags: [install, config]


## Deploy Homarr Docker environment file
# -----------------------------------------------------------------------------

- name: Get Homarr user UID and GID
  ansible.builtin.shell: |
    uid=$(id -u {{ homarr_user }})
    gid=$(id -g {{ homarr_group }})
    echo "{\"uid\": \"$uid\", \"gid\": \"$gid\"}"
  register: homarr_user_ids
  changed_when: false
  become: true
  tags: [install, config]

- name: Set Homarr UID and GID facts
  ansible.builtin.set_fact:
    homarr_uid: "{{ (homarr_user_ids.stdout | from_json).uid }}"
    homarr_gid: "{{ (homarr_user_ids.stdout | from_json).gid }}"
  tags: [install, config]

- name: Deploy Homarr environment file
  ansible.builtin.template:
    src: templates/homarr.conf.j2
    dest: "{{ homarr_config_file }}"
    owner: "{{ homarr_user }}"
    group: "{{ homarr_group }}"
    mode: '0644'
  become: true
  notify: Restart Homarr Docker
  tags: [install, config]


## Start Homarr Docker container
# -----------------------------------------------------------------------------

- name: Verify Homarr Docker Compose file exists
  ansible.builtin.stat:
    path: "{{ homarr_install_dir }}/docker-compose.yml"
  register: homarr_compose_stat
  tags: [verify]

- name: Display Homarr Docker Compose file status
  ansible.builtin.debug:
    msg: "Homarr Docker Compose file {{ 'exists' if homarr_compose_stat.stat.exists else 'does not exist' }} at {{ homarr_install_dir }}/docker-compose.yml"
  tags: [debug]

- name: Start Homarr Docker container
  community.docker.docker_compose:
    project_src: "{{ homarr_install_dir }}"
    state: present
    remove_orphans: true
  become: true
  register: homarr_result
  tags: [install, config, start]

- name: Display Homarr Docker deployment result
  ansible.builtin.debug:
    msg: "{{ homarr_result }}"
  when: homarr_result is defined
  tags: [debug]


## Configure UFW firewall
# -----------------------------------------------------------------------------

- name: Deploy Homarr UFW application profile
  ansible.builtin.template:
    src: templates/homarr-ufw-profile.j2
    dest: /etc/ufw/applications.d/homarr
    owner: root
    group: root
    mode: '0644'
  become: true
  notify: Reload UFW
  tags: [install, config, firewall]

- name: Reload UFW to recognize new application profile
  community.general.ufw:
    state: reloaded
  become: true
  tags: [install, config]

- name: Allow Homarr through UFW from allowed networks
  ansible.builtin.ufw:
    rule: allow
    name: "Homarr Dashboard"
    comment: "Allow Homarr Dashboard ({{ homarr_web_port }}/tcp) from LOCAL NET"
    src: "{{ item }}"
  loop: "{{ homarr_allowed_networks }}"
  become: true
  tags: [install, config, firewall]


## Configure Nginx reverse proxy
# -----------------------------------------------------------------------------

- name: Deploy Homarr Nginx location block
  ansible.builtin.template:
    src: templates/homarr-nginx-location.j2
    dest: "/etc/nginx/conf.d/{{ networking_nginx.hostname }}-homarr.conf"
    owner: root
    group: root
    mode: '0644'
  vars:
    homarr_web_port: "{{ homarr_web_port }}"
  become: true
  notify: Reload Nginx
  when: homarr_nginx_enabled
  tags: [install, config, nginx]


## Health checks and verification
# -----------------------------------------------------------------------------

- name: Wait for Homarr to be ready
  ansible.builtin.uri:
    url: "http://127.0.0.1:{{ homarr_web_port }}/api/health"
    method: GET
    status_code: 200
  register: homarr_health_check
  until: homarr_health_check.status == 200
  retries: 30
  delay: 10
  when: homarr_result.changed
  tags: [install, config, verify, healthcheck]

- name: Display Homarr health check result
  ansible.builtin.debug:
    msg: "Homarr is healthy and responding on port {{ homarr_web_port }}"
  when: homarr_health_check.status == 200
  tags: [install, config, verify, healthcheck]

- name: Verify Homarr container is running
  community.docker.docker_container_info:
    name: "{{ homarr_container_name }}"
  register: homarr_container_info
  become: true
  tags: [install, config, verify, healthcheck]

- name: Display Homarr container status
  ansible.builtin.debug:
    msg: |
      Homarr container status: {{ homarr_container_info.container.State.Status }}
      Container ID: {{ homarr_container_info.container.Id[:12] }}
      Image: {{ homarr_container_info.container.Image }}
      Ports: {{ homarr_container_info.container.NetworkSettings.Ports }}
  tags: [install, config, verify, healthcheck]


## Post-installation information
# -----------------------------------------------------------------------------

- name: Display Homarr installation summary
  ansible.builtin.debug:
    msg: |
      Homarr Dashboard has been successfully installed!

      Access URLs:
      {% if homarr_nginx_enabled %}
      - Via Nginx: https://{{ networking_nginx.hostname }}/
      {% endif %}
      - Direct: http://{{ ansible_hostname }}:{{ homarr_web_port }}

      Configuration:
      - Container: {{ homarr_container_name }}
      - Data directory: {{ homarr_data_dir }}
      - Config directory: {{ homarr_config_dir }}
      - Port: {{ homarr_web_port }}

      Next steps:
      1. Access Homarr web interface
      2. Configure your dashboard widgets
      3. Add integrations for your services
      4. Customize the layout and appearance
  tags: [install, summary]


## Uninstall Homarr
# -----------------------------------------------------------------------------

- name: Stop and remove Homarr Docker containers
  community.docker.docker_container:
    name: "{{ item }}"
    state: absent
  loop:
    - "{{ homarr_container_name }}"
    - "homarr-redis"
  become: true
  tags: [never, uninstall]

- name: Remove Homarr Docker network
  community.docker.docker_network:
    name: homarr_network
    state: absent
  become: true
  tags: [never, uninstall]

- name: Remove Homarr Docker image
  community.docker.docker_image:
    name: "{{ homarr_image }}"
    state: absent
  become: true
  tags: [never, uninstall]

- name: Remove Homarr directories
  ansible.builtin.file:
    path: "{{ item }}"
    state: absent
  loop:
    - "{{ homarr_install_dir }}"
    - "{{ homarr_data_dir }}"
    - "{{ homarr_config_dir }}"
  become: true
  tags: [never, uninstall]

- name: Remove Homarr Nginx location block
  ansible.builtin.file:
    path: "/etc/nginx/conf.d/{{ networking_nginx.hostname }}-homarr.conf"
    state: absent
  become: true
  notify: Reload Nginx
  when: homarr_nginx_enabled
  tags: [never, uninstall]

- name: Remove Homarr UFW application profile
  ansible.builtin.file:
    path: /etc/ufw/applications.d/homarr
    state: absent
  become: true
  notify: Reload UFW
  tags: [never, uninstall]

- name: Remove Homarr UFW rules
  community.general.ufw:
    rule: allow
    name: "Homarr Dashboard"
    src: "{{ item }}"
    delete: yes
  loop: "{{ homarr_allowed_networks }}"
  become: true
  tags: [uninstall, firewall]

- name: Remove Homarr system user
  ansible.builtin.user:
    name: "{{ homarr_user }}"
    state: absent
    remove: true
  become: true
  tags: [never, uninstall]

- name: Remove Homarr system group
  ansible.builtin.group:
    name: "{{ homarr_group }}"
    state: absent
  become: true
  tags: [never, uninstall]

- name: Display Homarr uninstall summary
  ansible.builtin.debug:
    msg: |
      Homarr Dashboard has been successfully uninstalled!

      Removed:
      - Docker container and network
      - Docker image
      - Configuration and data directories
      - Nginx configuration
      - UFW firewall rules
      - System user and group
  tags: [never, uninstall]
